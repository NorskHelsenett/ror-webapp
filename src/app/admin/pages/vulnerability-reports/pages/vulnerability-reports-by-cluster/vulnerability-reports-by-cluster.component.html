@if (vulnerabilityReports$ | async; as vulnerabilityReports) {
  <div>
    <p-table
      #clusterTable
      [loading]="loading"
      [sortOrder]="-1"
      sortField="criticalCount"
      [value]="vulnerabilityReports"
      [columns]="columns"
      [tableStyle]="{ 'min-width': '50rem' }"
    >
      <ng-template #header let-columns>
        <tr>
          @for (column of columns; track column) {
            <th [pSortableColumn]="column?.field" class="p-0">
              {{ 'pages.admin.vulnerabilityreports.clusterSummary.' + column?.field | translate }}<p-sortIcon [field]="column?.field"></p-sortIcon>
            </th>
          }
        </tr>
        <tr>
          @for (column of columns; track column) {
            <th class="p-0">
              @switch (column?.type) {
                @case ('text') {
                  <p-columnFilter type="text" [field]="column?.field" matchMode="contains" [showMenu]="false"></p-columnFilter>
                }
                @case ('env') {
                  <p-columnFilter [field]="column?.field" matchMode="in" [showMenu]="false">
                    <ng-template pTemplate="filter" let-value let-filter="filterCallback">
                      <p-multiSelect
                        [ngModel]="value"
                        appendTo="body"
                        [options]="environments"
                        placeholder="{{ 'common.any' | translate }}"
                        (onChange)="filter($event.value)"
                        optionLabel="name"
                        optionValue="value"
                        [maxSelectedLabels]="1"
                        [selectedItemsLabel]="'{0} items'"
                        [filter]="false"
                      >
                      </p-multiSelect>
                    </ng-template>
                  </p-columnFilter>
                }
              }
            </th>
          }
        </tr>
      </ng-template>
      <ng-template #caption>
        <p-iconField iconPosition="left">
          <input
            pInputText
            #globalSearchInput
            type="text"
            class="block w-full rounded-lg border border-gray-300 bg-gray-50 p-2 ps-10 text-sm text-gray-900 focus:border-blue-500 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400 dark:focus:border-blue-500 dark:focus:ring-blue-500"
            (input)="clusterTable.filterGlobal(globalSearchInput?.value, 'contains')"
            placeholder="{{ 'common.search' | translate }}"
          />
        </p-iconField>
      </ng-template>
      <ng-template #body let-report let-columns="columns">
        <tr>
          @for (column of columns; track column) {
            @switch (column?.field) {
              @case ('clusterId') {
                <td>
                  <a
                    [routerLink]="['./../../cluster/' + report?.clusterId]"
                    [queryParams]="{ tab: 'vulnerabilityReports' }"
                    class="ml-2 cursor-pointer hover:text-blue-800 hover:underline dark:hover:text-blue-400"
                    >{{ report?.clusterId }}</a
                  >
                </td>
              }
              @case ('project.name') {
                <td>
                  <a
                    [routerLink]="['./../projects/' + report?.project?.id]"
                    class="ml-2 cursor-pointer hover:text-blue-800 hover:underline dark:hover:text-blue-400"
                    >{{ report?.project?.name }}</a
                  >
                </td>
              }
              @case ('environment') {
                <td>
                  <app-cluster-environment [environmentTag]="report?.environment"></app-cluster-environment>
                </td>
              }
              @default {
                <td>{{ report[column?.field] }}</td>
              }
            }
          }
        </tr>
      </ng-template>
      <ng-template #emptymessage>
        <tr>
          <td colspan="5">
            {{ 'common.emptyList' | translate }}
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>
} @else {
  @if (error) {
    <div class="mx-auto my-4 flex items-center rounded-md bg-red-200 px-6 py-4 text-lg">
      <span class="p-2 text-red-800"> {{ 'pages.dashboard.error' | translate }} </span>
      <button class="btn text-black" (click)="getVulnerabilityReports()">{{ 'common.tryAgain' | translate }}</button>
    </div>
  } @else {
    <app-spinner></app-spinner>
  }
}
