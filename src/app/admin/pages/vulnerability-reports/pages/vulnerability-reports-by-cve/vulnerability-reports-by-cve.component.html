<div class="flex flex-col gap-5">
  <div class="flex flex-col gap-1">
    <div class="flex flex-row gap-1">
      <span class="p-input-icon-left">
        <input
          #cveinput
          type="text"
          class="form-control m-0 block w-full rounded border border-solid border-gray-300 bg-white bg-clip-padding px-3 py-1.5 text-base text-lg font-normal text-gray-600 transition ease-in-out focus:bg-white focus:text-gray-700 focus:outline-none dark:bg-gray-700 dark:text-white"
          aria-describedby="cveid-help"
          [(ngModel)]="id"
          (keyup.enter)="getVulnerabilityReports()"
        />
      </span>
      <button
        class="focus:ring-primary dark:focus:ring-offset-dark ml-2 rounded-md bg-green-700 px-4 py-2 text-lg text-white hover:bg-green-500 focus:outline-none focus:ring focus:ring-offset-1 focus:ring-offset-white"
        pButton
        pRipple
        [disabled]="id?.length === 0"
        (click)="getVulnerabilityReports()"
      >
        {{ 'common.search' | translate }}
      </button>
    </div>
    <span id="cveid-help">{{ 'pages.admin.vulnerabilityreports.cveid.searchHelp' | translate }}</span>
  </div>

  @if (!error) {
    <p-table [value]="vulnerabilityReports$ | async" [columns]="columns" [loading]="loading" [tableStyle]="{ 'min-width': '50rem' }">
      <ng-template #header let-columns>
        <tr>
          @for (column of columns; track column) {
            <th [pSortableColumn]="column">
              {{ 'pages.admin.vulnerabilityreports.cveid.' + column?.field | translate }}<p-sortIcon [field]="column?.field"></p-sortIcon>
            </th>
          }
        </tr>
        <tr>
          @for (column of columns; track column) {
            <th class="p-0">
              @switch (column?.type) {
                @case ('text') {
                  <p-columnFilter type="text" [field]="column?.field" matchMode="contains" [showMenu]="false"></p-columnFilter>
                }
                @case ('env') {
                  <p-columnFilter [field]="column?.field" matchMode="in" [showMenu]="false">
                    <ng-template pTemplate="filter" let-value let-filter="filterCallback">
                      <p-multiSelect
                        [ngModel]="value"
                        appendTo="body"
                        [options]="environments"
                        placeholder="{{ 'common.any' | translate }}"
                        (onChange)="filter($event.value)"
                        optionLabel="name"
                        optionValue="value"
                        [maxSelectedLabels]="1"
                        [selectedItemsLabel]="'{0} items'"
                        [filter]="false"
                      >
                      </p-multiSelect>
                    </ng-template>
                  </p-columnFilter>
                }
                @case ('sensitivity') {
                  <p-columnFilter [field]="column?.field" matchMode="in" [showMenu]="false">
                    <ng-template pTemplate="filter" let-value let-filter="filterCallback">
                      <p-multiSelect
                        [ngModel]="value"
                        appendTo="body"
                        [options]="availableSensitivities"
                        placeholder="{{ 'common.any' | translate }}"
                        (onChange)="filter($event.value)"
                        optionLabel="name"
                        optionValue="value"
                        [maxSelectedLabels]="1"
                        [selectedItemsLabel]="'{0} items'"
                        [filter]="false"
                      >
                      </p-multiSelect>
                    </ng-template>
                  </p-columnFilter>
                }
                @case ('criticality') {
                  <p-columnFilter [field]="column?.field" matchMode="in" [showMenu]="false">
                    <ng-template pTemplate="filter" let-value let-filter="filterCallback">
                      <p-multiSelect
                        [ngModel]="value"
                        appendTo="body"
                        [options]="availableCriticalities"
                        placeholder="{{ 'common.any' | translate }}"
                        (onChange)="filter($event.value)"
                        optionLabel="name"
                        optionValue="value"
                        [maxSelectedLabels]="1"
                        [selectedItemsLabel]="'{0} items'"
                        [filter]="false"
                      >
                      </p-multiSelect>
                    </ng-template>
                  </p-columnFilter>
                }
              }
            </th>
          }
        </tr>
      </ng-template>
      <ng-template #body let-report let-columns="columns">
        <tr>
          @for (column of columns; track column) {
            @switch (column?.field) {
              @case ('clusterId') {
                <td>
                  <a
                    [routerLink]="['./../../cluster/' + report?.clusterId]"
                    [queryParams]="{ tab: 'vulnerabilityReports' }"
                    class="ml-2 cursor-pointer hover:text-blue-800 hover:underline dark:hover:text-blue-400"
                    >{{ report?.clusterId }}</a
                  >
                </td>
              }
              @case ('project.name') {
                <td>
                  <a
                    [routerLink]="['./../projects/' + report?.project?.id]"
                    class="ml-2 cursor-pointer hover:text-blue-800 hover:underline dark:hover:text-blue-400"
                    >{{ report?.project?.name }}</a
                  >
                </td>
              }
              @case ('environment') {
                <td>
                  <app-cluster-environment [environmentTag]="report?.environment"></app-cluster-environment>
                </td>
              }
              @case ('criticality') {
                <td>
                  {{ 'common.availableCriticalities.' + report[column?.field] | translate }}
                </td>
              }
              @case ('sensitivity') {
                <td>
                  {{ 'common.availableSensitivities.' + report[column?.field] | translate }}
                </td>
              }
              @default {
                <td>
                  {{ report[column?.field] }}
                </td>
              }
            }
          }
        </tr>
      </ng-template>
      <ng-template #emptymessage>
        <tr>
          @if (searchTimeStamp) {
            <td colspan="10">
              <b>{{ searchTimeStamp }}</b
              >: {{ 'pages.admin.vulnerabilityreports.cveid.notfound' | translate }}
            </td>
          }
          @if (!searchTimeStamp) {
            <td colspan="10">{{ 'common.emptyList' | translate }}</td>
          }
        </tr>
      </ng-template>
    </p-table>
  } @else {
    @if (error) {
      <div class="mx-auto my-4 flex items-center rounded-md bg-red-200 px-6 py-4 text-lg">
        <span class="p-2 text-red-800">
          {{ 'common.errorLoading' | translate }} <br />
          {{ ('common.error' | translate) + ': ' + error?.message }}
        </span>
      </div>
    }
  }
</div>
