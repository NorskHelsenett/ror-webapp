@if (reports$ | async; as reports) {
  <div>
    <div class="dark:border-primary-darker gap-4 px-4 pb-2 lg:pb-4 flex flex-row-reverse items-center border-b">
      <div
        class="hover:bg-primary-dark focus:ring-primary dark:focus:ring-offset-dark rounded-md bg-green-700 text-sm text-white focus:ring-offset-white relative focus:ring focus:ring-offset-1 focus:outline-none"
        (click)="showExportChoices = !showExportChoices"
      >
        <div class="rounded-md px-4 py-2 relative flex w-fit cursor-pointer items-center justify-center">
          <div class="mr-2">{{ 'common.export' | translate }}</div>
          <div>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
            </svg>
          </div>
        </div>
        @if (showExportChoices) {
          <div class="mt-2 rounded-md p-3 absolute z-50 w-fit cursor-pointer">
            <a
              class="hover:bg-primary-dark focus:ring-primary dark:focus:ring-offset-dark mt-0 rounded-md bg-blue-700 px-4 py-2 text-sm text-white focus:ring-offset-white w-full opacity-75 focus:ring focus:ring-offset-1 focus:outline-none"
              (click)="exportToCsv(reports)"
            >
              CSV
            </a>
            <div
              class="hover:bg-primary-dark focus:ring-primary dark:focus:ring-offset-dark mt-2 rounded-md bg-blue-700 px-4 py-2 text-sm text-white focus:ring-offset-white w-full opacity-75 focus:ring focus:ring-offset-1 focus:outline-none"
              (click)="exportToExcel(reports)"
            >
              Excel
            </div>
          </div>
        }
      </div>
    </div>
    <app-vulnerability-bar
      [critical]="reports?.criticalCount"
      [high]="reports?.highCount"
      [medium]="reports?.mediumCount"
      [low]="reports?.lowCount"
      [total]="reports?.total"
    ></app-vulnerability-bar>
    <p-table sortField="criticalCount" [sortOrder]="-1" [value]="reports?.namespaces" dataKey="name">
      <ng-template #header let-namespace>
        <tr>
          <th style="width: 5rem" class="p-1"></th>
          <th pSortableColumn="name">
            {{ 'pages.clusters.details.vulnerabilityreports.namespace' | translate }}
            <p-sortIcon field="name"></p-sortIcon>
          </th>
          <th pSortableColumn="criticalCount" class="p-1">
            {{ 'pages.clusters.details.vulnerabilityreports.critical' | translate }} ({{ reports?.criticalCount }})
            <p-sortIcon field="criticalCount"></p-sortIcon>
          </th>
          <th pSortableColumn="highCount" class="p-1">
            {{ 'pages.clusters.details.vulnerabilityreports.high' | translate }} ({{ reports?.highCount }})
            <p-sortIcon field="highCount"></p-sortIcon>
          </th>
          <th pSortableColumn="mediumCount" class="p-1">
            {{ 'pages.clusters.details.vulnerabilityreports.medium' | translate }} ({{ reports?.mediumCount }})
            <p-sortIcon field="mediumCount"></p-sortIcon>
          </th>
          <th pSortableColumn="lowCount" class="p-1">
            {{ 'pages.clusters.details.vulnerabilityreports.low' | translate }} ({{ reports?.lowCount }})
            <p-sortIcon field="lowCount"></p-sortIcon>
          </th>
          <th pSortableColumn="total" class="p-1">
            {{ 'pages.clusters.details.vulnerabilityreports.total' | translate }} ({{ reports?.total }})
            <p-sortIcon field="total"></p-sortIcon>
          </th>
        </tr>
      </ng-template>
      <ng-template #body let-namespace let-expanded="expanded">
        <tr>
          <td>
            <button
              type="button"
              pButton
              sortfilter="failed"
              pRipple
              [pRowToggler]="namespace"
              class="p-button-text p-button-rounded p-button-plain"
              [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"
            ></button>
          </td>
          <td>{{ namespace?.name }}</td>
          <td>{{ namespace?.criticalCount }}</td>
          <td>{{ namespace?.highCount }}</td>
          <td>{{ namespace?.mediumCount }}</td>
          <td>{{ namespace?.lowCount }}</td>
          <td>{{ namespace?.total }}</td>
        </tr>
      </ng-template>
      <ng-template #expandedrow let-namespace>
        <tr>
          <td colspan="10">
            <div class="gap-8 grid">
              <div class="dark:bg-darker rounded-md bg-white p-4">
                <div class="dark:bg-darker rounded-md bg-white">
                  <div class="p-3 relative">
                    <app-vulnerability-namespace [namespace]="namespace"></app-vulnerability-namespace>
                  </div>
                </div>
              </div>
            </div>
          </td>
        </tr>
      </ng-template>
      <ng-template #emptymessage>
        <tr>
          <td colspan="7">{{ 'common.emptyList' | translate }}</td>
        </tr>
      </ng-template>
    </p-table>
  </div>
} @else {
  @if (reportsError) {
    <div class="my-4 rounded-md bg-red-200 px-6 py-4 text-lg mx-auto flex items-center">
      <span class="p-2 text-red-800">
        {{ 'common.errorLoading' | translate }} <br />
        {{ ('common.error' | translate) + ': ' + reportsError.message }}
      </span>
    </div>
  }
}
